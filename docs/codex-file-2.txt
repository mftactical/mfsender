/*
 * This file is part of mfsender.
 *
 * Purpose:
 * --------
 * Central initialization point for all user input controls:
 * - Keyboard shortcuts
 * - Gamepad bindings
 * - Macro preloading for input-triggered execution
 *
 * This module is intentionally lightweight and orchestration-only.
 * It does NOT:
 * - Execute CNC commands directly
 * - Contain business logic for macros
 * - Handle UI rendering
 *
 * mfsender is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * mfsender is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with mfsender. If not, see <https://www.gnu.org/licenses/>.
 */

import { registerCoreKeyboardActions } from './actions';
import { keyBindingStore } from './key-binding-store';
import { gamepadBindingStore } from './gamepad-binding-store';
import { getKeyboardManager } from './keyboard-manager';
import { getGamepadManager } from './gamepad-manager';
import { useMacroStore } from '../macro/store';
import type { InitData } from '@/lib/init';

/**
 * Initializes all input-related subsystems used by mfsender.
 *
 * Responsibilities:
 * - Bootstraps keyboard and gamepad binding stores
 * - Registers core (non-user) keyboard actions
 * - Instantiates keyboard and gamepad managers
 * - Loads macros early to ensure shortcuts/macros are usable immediately
 *
 * Design notes:
 * - Macro loading is treated as non-critical; failures must NOT block input init
 * - When initData is provided, macros are injected synchronously to avoid
 *   additional async fetches during startup
 *
 * @param initData Optional pre-fetched initialization data from backend
 */
export function initializeKeyboardShortcuts(initData?: InitData): void {
  keyBindingStore.bootstrap();
  gamepadBindingStore.bootstrap();
  registerCoreKeyboardActions();

  // Force manager instantiation (side-effect based initialization)
  getKeyboardManager();
  getGamepadManager();

  // Load macros from pre-fetched init data if available
  if (initData?.macros) {
    const macroStore = useMacroStore();
    macroStore.setMacros(initData.macros);
  } else {
    // Fallback: async macro loading (non-blocking, best-effort)
    try {
      const macroStore = useMacroStore();
      macroStore.loadMacros?.().catch(() => {
        // Macro loading is non-critical for keyboard initialization
      });
    } catch (error) {
      // Defensive: macro store may not be available during early startup
      console.warn('Failed to pre-load macros for keyboard shortcuts:', error);
    }
  }
}

// Re-exports for external consumers
export { keyBindingStore } from './key-binding-store';
export { normalizeCombo, comboFromEvent } from './keyboard-utils';
